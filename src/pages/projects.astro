---
import Layout from "../layouts/Layout.astro";
import { useTranslations, defaultLang, type Lang } from "../utils/i18n";
import projectsData from "../data/projects.json";
import Navbar from "../components/Navbar.astro";

const lang: Lang = defaultLang;
const t = useTranslations(lang);

// Helper function to get project description
const getProjectDescription = (projectId: string) => {
  return t(`projects.${projectId}` as any);
};

// Separate featured and non-featured projects
const featuredProjects = projectsData.projects.filter((p) => p.featured);
const otherProjects = projectsData.projects.filter((p) => !p.featured);

// Combine: featured first, then others
const allProjects = [...featuredProjects, ...otherProjects];

// Extract unique technologies for filters
const allTechnologies = [
  ...new Set(
    projectsData.projects.flatMap((project) => project.technologies)
  ),
].sort();
---

<Layout
  title={`${t("home.projects.allProjects")} - Joan Guinart`}
  description={t("home.projects.subtitle")}
  lang={lang}
>
  <Navbar lang={lang} />

  <main class="projects-page">
    <div class="container">
      <!-- Page Header -->
      <header class="page-header">
        <h1 class="page-title">{t("home.projects.allProjects")}</h1>
        <p class="page-subtitle">{t("home.projects.subtitle")}</p>
        <div class="projects-count">
          <span class="count-number">{allProjects.length}</span>
          <span class="count-label">{t("home.projects.projectsCount")}</span>
        </div>
      </header>

      <!-- Filter Bar -->
      <div class="filter-bar">
        <label for="tech-filter" class="filter-label">
          {t("home.projects.filterByTech")}:
        </label>
        <select id="tech-filter" class="filter-select">
          <option value="all">{t("home.projects.filterAll")}</option>
          {
            allTechnologies.map((tech) => (
              <option value={tech}>{tech}</option>
            ))
          }
        </select>
      </div>

      <!-- Projects Grid -->
      <div class="projects-grid" id="projects-grid">
        {
          allProjects.map((project) => (
            <article
              class="project-card"
              data-technologies={JSON.stringify(project.technologies)}
              data-featured={project.featured}
            >
              <a
                href={project.demoUrl || "#"}
                target={project.demoUrl ? "_blank" : "_self"}
                rel={project.demoUrl ? "noopener noreferrer" : ""}
                class="project-link"
              >
                <div class="project-image">
                  {project.featured && (
                    <div class="featured-badge">Featured</div>
                  )}
                  <img
                    src={`/images/projects/${project.image}`}
                    alt={project.title}
                    loading="lazy"
                  />
                  <div class="project-overlay">
                    <span class="view-project">
                      {t("home.projects.viewProject")}
                    </span>
                  </div>
                </div>

                <div class="project-info">
                  <div class="project-header">
                    <h2 class="project-title">{project.title}</h2>
                    <span class="project-client">
                      {t("home.projects.client")}: {project.client}
                    </span>
                  </div>

                  <p class="project-description">{getProjectDescription(project.id)}</p>

                  <div class="project-technologies">
                    {project.technologies.map((tech) => (
                      <span class="tech-tag">{tech}</span>
                    ))}
                  </div>

                  <div class="project-year">{project.year}</div>
                </div>
              </a>
            </article>
          ))
        }
      </div>

      <!-- No Results Message -->
      <div class="no-results" id="no-results" style="display: none;">
        <p>No projects found with the selected technology.</p>
      </div>
    </div>
  </main>
</Layout>

<script>
  // Filter functionality
  const filterSelect = document.getElementById(
    "tech-filter"
  ) as HTMLSelectElement;
  const projectsGrid = document.getElementById("projects-grid");
  const noResults = document.getElementById("no-results");
  const projectCards = document.querySelectorAll(".project-card");

  filterSelect?.addEventListener("change", (e) => {
    const selectedTech = (e.target as HTMLSelectElement).value;
    let visibleCount = 0;

    projectCards.forEach((card) => {
      const cardElement = card as HTMLElement;
      const technologies = JSON.parse(
        cardElement.dataset.technologies || "[]"
      );

      if (selectedTech === "all" || technologies.includes(selectedTech)) {
        cardElement.style.display = "block";
        visibleCount++;
      } else {
        cardElement.style.display = "none";
      }
    });

    // Show/hide no results message
    if (noResults && projectsGrid) {
      if (visibleCount === 0) {
        projectsGrid.style.display = "none";
        noResults.style.display = "flex";
      } else {
        projectsGrid.style.display = "grid";
        noResults.style.display = "none";
      }
    }
  });
</script>

<style lang="scss">
  @use "../_mediaqueries.scss" as *;
  @use "../styles/variables" as *;

  .projects-page {
    min-height: 100vh;
    background: var(--color-surface);
    padding: calc(var(--space-20) + 70px) 0 var(--space-20) 0;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 var(--space-6);
  }

  // Page Header
  .page-header {
    text-align: center;
    margin-bottom: var(--space-12);
  }

  .page-title {
    font-size: var(--font-size-5xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-text-primary);
    margin: 0 0 var(--space-4) 0;

    @include md {
      font-size: var(--font-size-6xl);
    }
  }

  .page-subtitle {
    font-size: var(--font-size-lg);
    color: var(--color-text-secondary);
    line-height: var(--line-height-relaxed);
    max-width: 600px;
    margin: 0 auto var(--space-6) auto;
  }

  .projects-count {
    display: inline-flex;
    align-items: baseline;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-6);
    background: var(--color-primary-100);
    border-radius: var(--radius-full);
  }

  .count-number {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-primary-700);
  }

  .count-label {
    font-size: var(--font-size-sm);
    color: var(--color-primary-600);
    font-weight: var(--font-weight-medium);
  }

  // Filter Bar
  .filter-bar {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    margin-bottom: var(--space-8);
    padding: var(--space-4);
    background: var(--color-surface-elevated);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-base);

    @include md {
      justify-content: center;
    }
  }

  .filter-label {
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-primary);
  }

  .filter-select {
    padding: var(--space-2) var(--space-4);
    font-size: var(--font-size-base);
    color: var(--color-text-primary);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-base);
    cursor: pointer;
    transition: all var(--transition-base);

    &:hover {
      border-color: var(--color-primary-300);
    }

    &:focus {
      outline: none;
      border-color: var(--color-primary-500);
      box-shadow: 0 0 0 3px rgba(6, 78, 59, 0.1);
    }
  }

  // Projects Grid
  .projects-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-8);

    @include md {
      grid-template-columns: repeat(2, 1fr);
    }

    @include xl {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  .project-card {
    background: var(--color-surface-elevated);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    transition: all var(--transition-base);

    &[data-featured="true"] {
      border-color: var(--color-primary-300);
    }

    &:hover {
      border-color: var(--color-primary-200);
      box-shadow: var(--shadow-lg);
      transform: translateY(-4px);

      .project-overlay {
        opacity: 1;
      }

      .project-image img {
        transform: scale(1.05);
      }
    }
  }

  .project-link {
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .project-image {
    position: relative;
    width: 100%;
    height: 240px;
    overflow: hidden;
    background: var(--color-surface);

    img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform var(--transition-base);
    }
  }

  .featured-badge {
    position: absolute;
    top: var(--space-4);
    right: var(--space-4);
    padding: var(--space-1) var(--space-3);
    background: var(--color-primary-600);
    color: var(--color-primary-50);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-semibold);
    border-radius: var(--radius-full);
    z-index: 10;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .project-overlay {
    position: absolute;
    inset: 0;
    background: rgba(6, 78, 59, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity var(--transition-base);
  }

  .view-project {
    color: var(--color-accent-50);
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .project-info {
    padding: var(--space-6);
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .project-header {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .project-title {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    margin: 0;
  }

  .project-client {
    font-size: var(--font-size-sm);
    color: var(--color-primary-500);
    font-weight: var(--font-weight-medium);
  }

  .project-description {
    font-size: var(--font-size-base);
    color: var(--color-text-secondary);
    line-height: var(--line-height-relaxed);
    margin: 0;
  }

  .project-technologies {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .tech-tag {
    font-size: var(--font-size-xs);
    padding: var(--space-1) var(--space-3);
    background: var(--color-primary-100);
    color: var(--color-primary-700);
    border-radius: var(--radius-full);
    font-weight: var(--font-weight-medium);
  }

  .project-year {
    font-size: var(--font-size-sm);
    color: var(--color-text-tertiary);
    font-weight: var(--font-weight-medium);
    margin-top: auto;
    padding-top: var(--space-2);
    border-top: 1px solid var(--color-border);
  }

  // No Results
  .no-results {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 300px;
    text-align: center;

    p {
      font-size: var(--font-size-lg);
      color: var(--color-text-secondary);
    }
  }
</style>
